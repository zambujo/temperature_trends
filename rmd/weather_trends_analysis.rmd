---
title: "Exploring Weather Trends"
author: "Joao Martins"
date: "6/2/2020"
output:
  tufte::tufte_handout: default
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
library(reticulate)
use_condaenv("r-reticulate", required = TRUE)
knitr::opts_chunk$set(echo = TRUE)
```


# Outline

Below, we explore weather trends.  We compare local and global trends.  In particular, we compare average temperature records in Bern, Switzerland, against the world's average temperature^[measured in Celcius] between 1750 and 2013.  We take the following steps:

1. query a database embedded in the udacity project website using SQL (see query in the annex);

2. load, prepare, and visualize the trends using Python (see script in the annex):  
  2.1. [`pandas`](https://github.com/pandas-dev/pandas) opens and cleans the CSV table;  
  2.2. [`plotnine`](https://github.com/has2k1/plotnine) produces a line chart with moving temperature averages^[while using `pandas.rolling()` function to calculate the moving average];

3. display the results in a PDF document thanks to [R Markdown](https://rmarkdown.rstudio.com) and the [`tufte` package](https://github.com/rstudio/tufte).


# Observations

```{python prep, include=FALSE}
import pandas as pd
from plotnine import *
temperature_trends = pd.read_csv("../data/average_temperature_trends.csv")
tt=temperature_trends\
  .dropna()\
  .drop(['city', 'country'], axis=1)\
  .melt(id_vars=['year'],\
        var_name = 'location',\
        value_name = 'average_temperature')
tt['Location'] = tt['location'].str.replace('_average_temperature', '')
tt['Location'] = tt['Location'].str.replace('global', 'World')
tt['Location'] = tt['Location'].str.replace('local', 'Bern, Switzerland')
p=ggplot(tt, aes(x='year', y='average_temperature', color='Location')) \
+ geom_point(alpha = .15, size = 1) \
+ geom_smooth(method="mavg", method_args={'window': 10},  se=False) \
+ xlab('Date') \
+ ylab('Average Temperature (Cº)') \
+ theme_minimal() \
+ theme(legend_position=(0.75, 0.25))
```


```{python plot, echo=FALSE, results='hide', fig.keep='all', fig.cap='Average temperatures(ºC) between 1750 and 2013.  Each dot represents the average temperature over 1 year. Lines show a moving average temperature over a time period of 10 years.  Bern temperatures are shown in red, world temperatures in blue.'}
p
```

Figure 1 shows that Bern average temperatures are consistently lower than world average.

\newpage

# Source code

## SQL

```{sql download, eval=FALSE}
-- check cities in Switzerland
select city
from city_list
where country = 'Switzerland'
-- download local (Bern) and global average temperatures
select city
     , country
     , temperature_trends.year
     , temperature_trends.avg_temp as local_average_temperature
     , global_data.avg_temp as global_average_temperature
from temperature_trends
full outer join global_data on temperature_trends.year = global_data.year
where country = 'Switzerland' and city = 'Bern'
```

--- 

## Python

```{python src, eval=FALSE}
import pandas as pd
from plotnine import *

# ------- open/inspect CSV file in ../data folder

temperature_trends = pd.read_csv("../data/average_temperature_trends.csv")
temperature_trends.info()

# ------- data preparation

tt=temperature_trends\
  .dropna()\
  .drop(['city', 'country'], axis=1)
assert(tt.year.duplicated().sum() == 0, "TODO: remove duplicates")

# normal form
tt=tt\
  .melt(id_vars=['year'],\
        var_name = 'location',\
        value_name = 'average_temperature')
# recode values
tt['Location'] = tt['location'].str.replace('_average_temperature', '')
tt['Location'] = tt['Location'].str.replace('global', 'World')
tt['Location'] = tt['Location'].str.replace('local', 'Bern, Switzerland')

# ------- line charts with moving averages

ggplot(tt, aes(x='year', y='average_temperature', color='Location')) \
+ geom_point(alpha = .15, size = 1) \
+ geom_smooth(method="mavg", method_args={'window': 10},  se=False) \
+ xlab('Date') \
+ ylab('Average Temperature (Cº)') \
+ theme_minimal() \
+ theme(legend_position=(0.75, 0.25))
```
